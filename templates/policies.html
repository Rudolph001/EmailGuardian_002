
{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-shield-alt me-2"></i>ML Policies Management</h2>
            <p class="text-muted">Manage policies used in machine learning risk scoring calculations.</p>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>How Policies Work:</strong> 
                <ul class="mb-2 mt-2">
                    <li><strong>Detection:</strong> Policies automatically trigger when their exact name appears in your event data's policy names field</li>
                    <li><strong>Risk Scoring:</strong> Each policy adds its risk weight to the event's ML risk score when matched</li>
                    <li><strong>Data Source:</strong> Policy names come from your imported event data (CSV files)</li>
                    <li><strong>Custom Rules:</strong> For pattern-based detection (keywords, domains, etc.), use <a href="{{ url_for('rules') }}" class="alert-link">Rules</a> instead</li>
                </ul>
                <div class="alert alert-warning mb-0 mt-3">
                    <strong><i class="fas fa-exclamation-triangle me-1"></i>Important Clarification:</strong>
                    These policies do <strong>NOT</strong> analyze actual email content, attachments, or behavior. They only look for exact text matches in the policy name field of your imported data. For example, "Suspicious Attachment" only triggers when an event has that exact text in its policy name - it doesn't examine actual attachment files for suspicious characteristics.
                </div>
                <div class="alert alert-light border mt-2 mb-0">
                    <strong><i class="fas fa-lightbulb text-warning me-1"></i>Want Real Attachment Analysis?</strong>
                    <p class="mb-2 mt-1">To actually analyze attachments for suspicious content, you would need:</p>
                    <ul class="mb-2">
                        <li><strong>File Type Rules:</strong> Block/flag specific extensions (.exe, .scr, .bat)</li>
                        <li><strong>Size Rules:</strong> Flag unusually large attachments</li>
                        <li><strong>Content Analysis:</strong> Scan file contents for malware signatures</li>
                        <li><strong>DLP Integration:</strong> Connect with Data Loss Prevention tools</li>
                    </ul>
                    <p class="mb-0"><small>These would be implemented as custom <a href="{{ url_for('rules') }}" class="alert-link">Rules</a> or through integration with external security tools.</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-populate from existing events -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Quick Start:</strong> Import policies from your existing events data automatically.
                <form method="post" style="display: inline; margin-left: 10px;">
                    <input type="hidden" name="action" value="auto_populate">
                    <button type="submit" class="btn btn-info btn-sm">
                        <i class="fas fa-download me-2"></i>Import Existing Policies
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add New Policy -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>Add New Policy
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        <input type="hidden" name="action" value="add">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="policy_name" class="form-label">Policy Name</label>
                                    <input type="text" class="form-control" id="policy_name" name="policy_name" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="risk_weight" class="form-label">Risk Weight</label>
                                    <input type="number" class="form-control" id="risk_weight" name="risk_weight" 
                                           step="0.1" min="0" max="10" value="1.0" required>
                                    <div class="form-text">Higher values increase risk score</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="category" class="form-label">Category</label>
                                    <select class="form-select" id="category" name="category">
                                        <option value="security">Security</option>
                                        <option value="compliance">Compliance</option>
                                        <option value="data_protection">Data Protection</option>
                                        <option value="business">Business</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enabled" name="enabled" checked>
                                        <label class="form-check-label" for="enabled">
                                            Enabled
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="2" 
                                      placeholder="Description of what this policy covers..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Add Policy
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Policies -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Existing Policies ({{ policies|length }})
                    </h5>
                </div>
                <div class="card-body">
                    {% if policies %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Policy Name</th>
                                        <th>Category</th>
                                        <th>Risk Weight</th>
                                        <th>What It Detects</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Events Using</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for policy in policies %}
                                        <tr>
                                            <td>
                                                <strong>{{ policy.policy_name }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ 'danger' if policy.category == 'security' else 'warning' if policy.category == 'compliance' else 'info' if policy.category == 'data_protection' else 'success' if policy.category == 'business' else 'secondary' }}">
                                                    {{ policy.category|title }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ 'danger' if policy.risk_weight > 3 else 'warning' if policy.risk_weight > 1.5 else 'success' }}">
                                                    {{ policy.risk_weight }}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="text-start">
                                                    <div class="mb-2">
                                                        <strong class="text-primary">
                                                            <i class="fas fa-search me-1"></i>Detection Method:
                                                        </strong> 
                                                        <span class="badge bg-info">Policy Name Matching</span>
                                                    </div>
                                                    
                                                    {% if policy.policy_name == 'Suspicious Attachment' %}
                                                        <div class="alert alert-warning py-2 mb-2">
                                                            <strong><i class="fas fa-exclamation-triangle me-1"></i>Important:</strong> 
                                                            This policy does <strong>NOT</strong> analyze actual attachment files. 
                                                            It only triggers when imported events have "Suspicious Attachment" in their policy name field.
                                                        </div>
                                                        <div class="mb-1">
                                                            <strong>What it actually looks for:</strong><br>
                                                            <code class="text-dark bg-light px-2 py-1 rounded">policy_name CONTAINS "Suspicious Attachment"</code>
                                                        </div>
                                                        <div class="mb-1">
                                                            <strong>Data source:</strong> Policy names from your imported event data
                                                        </div>
                                                        <div class="mb-1">
                                                            <strong>To see real suspicious attachments:</strong> 
                                                            <span class="text-muted">You would need file analysis rules or DLP policies that examine actual attachment content, file types, etc.</span>
                                                        </div>
                                                    {% elif 'attachment' in policy.policy_name.lower() %}
                                                        <div class="mb-1">
                                                            <strong>Searches for:</strong><br>
                                                            <code class="text-dark bg-light px-2 py-1 rounded">policy_name CONTAINS "{{ policy.policy_name }}"</code>
                                                        </div>
                                                        <div class="mb-1">
                                                            <strong>Attachment-related detection:</strong> Based on policy names, not file analysis
                                                        </div>
                                                    {% elif 'external' in policy.policy_name.lower() %}
                                                        <div class="mb-1">
                                                            <strong>Searches for:</strong><br>
                                                            <code class="text-dark bg-light px-2 py-1 rounded">policy_name CONTAINS "{{ policy.policy_name }}"</code>
                                                        </div>
                                                        <div class="mb-1">
                                                            <strong>External email detection:</strong> Based on policy names from your data source
                                                        </div>
                                                    {% else %}
                                                        <div class="mb-1">
                                                            <strong>Searches for:</strong><br>
                                                            <code class="text-dark bg-light px-2 py-1 rounded">policy_name CONTAINS "{{ policy.policy_name }}"</code>
                                                        </div>
                                                        <div class="mb-1">
                                                            <strong>Data source:</strong> Policy names from imported events
                                                        </div>
                                                    {% endif %}
                                                    
                                                    <div class="mt-2 pt-2 border-top">
                                                        <strong class="text-{{ 'danger' if policy.risk_weight > 3 else 'warning' if policy.risk_weight > 1.5 else 'success' }}">
                                                            <i class="fas fa-chart-line me-1"></i>Risk Impact:
                                                        </strong> 
                                                        <span class="text-{{ 'danger' if policy.risk_weight > 3 else 'warning' if policy.risk_weight > 1.5 else 'success' }}">
                                                            +{{ policy.risk_weight }} points added to event risk score when matched
                                                        </span>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    {{ policy.description[:100] }}{% if policy.description|length > 100 %}...{% endif %}
                                                </small>
                                            </td>
                                            <td>
                                                {% if policy.enabled %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-check me-1"></i>Enabled
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-times me-1"></i>Disabled
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ policy.event_count }}</span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button type="button" class="btn btn-outline-primary btn-sm edit-policy-btn" 
                                                            data-policy-id="{{ policy.id }}"
                                                            data-policy-name="{{ policy.policy_name }}"
                                                            data-policy-weight="{{ policy.risk_weight }}"
                                                            data-policy-category="{{ policy.category }}"
                                                            data-policy-description="{{ policy.description }}"
                                                            data-policy-enabled="{{ policy.enabled|int }}"
                                                            title="Edit policy">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-info btn-sm policy-details-btn" 
                                                            data-policy-name="{{ policy.policy_name }}"
                                                            data-policy-description="{{ policy.description }}"
                                                            data-policy-event-count="{{ policy.event_count }}"
                                                            data-policy-weight="{{ policy.risk_weight }}"
                                                            title="View policy details">
                                                        <i class="fas fa-info-circle"></i>
                                                    </button>
                                                    <form method="post" style="display: inline;" 
                                                          onsubmit="return confirm('Are you sure you want to delete this policy?')">
                                                        <input type="hidden" name="action" value="delete">
                                                        <input type="hidden" name="policy_id" value="{{ policy.id }}">
                                                        <button type="submit" class="btn btn-outline-danger btn-sm">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Policies Found</h5>
                            <p class="text-muted">Add your first policy above to start managing ML risk scoring.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Policy Modal -->
<div class="modal fade" id="editPolicyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Policy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="editPolicyForm">
                <div class="modal-body">
                    <input type="hidden" name="action" value="edit">
                    <input type="hidden" name="policy_id" id="edit_policy_id">
                    
                    <div class="mb-3">
                        <label for="edit_policy_name" class="form-label">Policy Name</label>
                        <input type="text" class="form-control" id="edit_policy_name" name="policy_name" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_risk_weight" class="form-label">Risk Weight</label>
                                <input type="number" class="form-control" id="edit_risk_weight" name="risk_weight" 
                                       step="0.1" min="0" max="10" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit_category" class="form-label">Category</label>
                                <select class="form-select" id="edit_category" name="category">
                                    <option value="security">Security</option>
                                    <option value="compliance">Compliance</option>
                                    <option value="data_protection">Data Protection</option>
                                    <option value="business">Business</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_enabled" name="enabled">
                            <label class="form-check-label" for="edit_enabled">
                                Enabled
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Enhanced edit policy function with data attributes
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for edit buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-policy-btn')) {
            const btn = e.target.closest('.edit-policy-btn');
            const id = btn.getAttribute('data-policy-id');
            const name = btn.getAttribute('data-policy-name');
            const weight = btn.getAttribute('data-policy-weight');
            const category = btn.getAttribute('data-policy-category');
            const description = btn.getAttribute('data-policy-description');
            const enabled = btn.getAttribute('data-policy-enabled');
            
            editPolicy(id, name, weight, category, description, enabled);
        }
        
        // Handle policy details button
        if (e.target.closest('.policy-details-btn')) {
            const btn = e.target.closest('.policy-details-btn');
            const name = btn.getAttribute('data-policy-name');
            const description = btn.getAttribute('data-policy-description');
            const eventCount = btn.getAttribute('data-policy-event-count');
            const weight = btn.getAttribute('data-policy-weight');
            
            showPolicyDetails(name, description, eventCount, weight);
        }
    });
});

function editPolicy(id, name, weight, category, description, enabled) {
    document.getElementById('edit_policy_id').value = id;
    document.getElementById('edit_policy_name').value = name;
    document.getElementById('edit_risk_weight').value = weight;
    document.getElementById('edit_category').value = category;
    document.getElementById('edit_description').value = description;
    document.getElementById('edit_enabled').checked = enabled == 1;
    
    var modal = new bootstrap.Modal(document.getElementById('editPolicyModal'));
    modal.show();
}

// Function to show policy details
function showPolicyDetails(policyName, description, eventCount, weight) {
    let detectionExplanation = '';
    let specificInfo = '';
    
    if (policyName === 'Suspicious Attachment') {
        detectionExplanation = `This policy does <strong>NOT</strong> analyze actual attachment files for suspicious content. It only triggers when imported events have "Suspicious Attachment" in their policy name field.`;
        specificInfo = `
            <div class="alert alert-warning mb-3">
                <h6><i class="fas fa-exclamation-triangle me-1"></i>Common Misconception</h6>
                <p class="mb-1">This policy doesn't examine:</p>
                <ul class="mb-2">
                    <li>Actual attachment file content</li>
                    <li>File types (.exe, .zip, etc.)</li>
                    <li>File sizes or suspicious file names</li>
                    <li>Malware scanning results</li>
                </ul>
                <p class="mb-0"><strong>It only looks for:</strong> The text "Suspicious Attachment" in the policy name field of your imported event data.</p>
            </div>`;
    } else if (policyName.toLowerCase().includes('attachment')) {
        detectionExplanation = `This policy triggers when "${policyName}" appears in the policy name field of imported events. It does not analyze actual attachment content.`;
        specificInfo = `
            <div class="alert alert-info mb-3">
                <strong>Attachment-related Policy:</strong> This policy name suggests it may be related to attachments, but it only performs text matching on policy names, not file analysis.
            </div>`;
    } else {
        detectionExplanation = `This policy triggers when "${policyName}" appears in the policy name field of imported events.`;
    }
    
    const detailsHtml = `
        <div class="policy-details">
            <h6><strong>Policy: ${policyName}</strong></h6>
            
            <div class="mb-3">
                <strong>How it works:</strong>
                <p class="mt-2">${detectionExplanation}</p>
                <ul class="mt-2">
                    <li>Searches for exact text match: "<code>${policyName}</code>"</li>
                    <li>When triggered, adds <strong>+${weight}</strong> to the event's risk score</li>
                    <li>Currently used by <strong>${eventCount}</strong> events in your system</li>
                </ul>
            </div>
            
            ${specificInfo}
            
            <div class="mb-3">
                <strong>Detection Method:</strong>
                <span class="badge bg-info">Exact Policy Name Match</span>
            </div>
            
            <div class="mb-3">
                <strong>Risk Impact:</strong>
                <span class="badge bg-${weight > 3 ? 'danger' : weight > 1.5 ? 'warning' : 'success'}">
                    ${weight > 3 ? 'High' : weight > 1.5 ? 'Medium' : 'Low'} Risk (+${weight})
                </span>
            </div>
            
            ${description ? `
            <div class="mb-3">
                <strong>Description:</strong>
                <p class="text-muted mt-1">${description}</p>
            </div>
            ` : ''}
            
            <div class="alert alert-info">
                <small>
                    <strong>Note:</strong> Policies are automatically applied during data ingestion when the policy name matches. 
                    To create custom detection rules based on patterns, use the <a href="/rules" target="_blank">Rules</a> section.
                </small>
            </div>
        </div>
    `;
    
    // Create and show modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-shield-alt me-2"></i>Policy Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    ${detailsHtml}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // Clean up modal after hiding
    modal.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modal);
    });
}
</script>
{% endblock %}
