{% extends "base.html" %}

{% block title %}Event Details - Email Guardian{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-envelope-open me-2"></i>Event Details
            </h1>
            <a href="{{ url_for('events') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Events
            </a>
        </div>
    </div>
</div>

<!-- Event Overview -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Event Information
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">Event ID:</dt>
                            <dd class="col-sm-8">{{ event.id }}</dd>

                            <dt class="col-sm-4">Time:</dt>
                            <dd class="col-sm-8">{{ event._time }}</dd>

                            <dt class="col-sm-4">Sender:</dt>
                            <dd class="col-sm-8">
                                <code>{{ event.sender }}</code>
                            </dd>

                            <dt class="col-sm-4">Subject:</dt>
                            <dd class="col-sm-8">
                                <em>{{ event.subject or 'No subject' }}</em>
                            </dd>

                            <dt class="col-sm-4">Department:</dt>
                            <dd class="col-sm-8">{{ event.department or 'Not specified' }}</dd>

                            <dt class="col-sm-4">Business Unit:</dt>
                            <dd class="col-sm-8">{{ event.bunit or 'Not specified' }}</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="row">
                            <dt class="col-sm-4">ML Score:</dt>
                            <dd class="col-sm-8">
                                {% if event.ml_score %}
                                    {% set score = event.ml_score %}
                                    <span class="badge bg-{{ 'danger' if score > 0.7 else 'warning' if score > 0.3 else 'success' }} me-2">
                                        {{ "%.3f"|format(score) }}
                                    </span>
                                    <div class="progress mt-1" style="height: 8px;">
                                        <div class="progress-bar bg-{{ 'danger' if score > 0.7 else 'warning' if score > 0.3 else 'success' }}"
                                             style="width: {{ (score * 100)|round }}%"></div>
                                    </div>
                                    <small class="text-muted">Model: {{ event.ml_model_version }}</small>
                                {% else %}
                                    <span class="text-muted">Not scored</span>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-4">Type:</dt>
                            <dd class="col-sm-8">
                                {% if event.is_internal_to_external %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-exchange-alt me-1"></i>Internal â†’ External
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-building me-1"></i>Internal
                                    </span>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-4">Leaver:</dt>
                            <dd class="col-sm-8">
                                {% if event.leaver %}
                                    <span class="badge bg-danger">
                                        <i class="fas fa-user-times me-1"></i>Yes
                                    </span>
                                    {% if event.termination_date %}
                                        <br><small class="text-muted">Term Date: {{ event.termination_date }}</small>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-user-check me-1"></i>No
                                    </span>
                                {% endif %}
                            </dd>

                            <dt class="col-sm-4">User Response:</dt>
                            <dd class="col-sm-8">{{ event.user_response or 'Not specified' }}</dd>

                            <dt class="col-sm-4">Final Outcome:</dt>
                            <dd class="col-sm-8">
                                {% if event.final_outcome %}
                                    <span class="badge bg-{{ 'danger' if event.final_outcome.lower() in ['risky', 'block'] else 'warning' if event.final_outcome.lower() in ['escalate', 'review'] else 'success' }}">
                                        {{ event.final_outcome }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">Not specified</span>
                                {% endif %}
                            </dd>
                        </dl>
                    </div>
                </div>

                {% if event.justifications %}
                    <div class="mt-3">
                        <strong>Justifications:</strong>
                        <p class="mt-2">{{ event.justifications }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Applied Rules and Actions -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-gavel me-2"></i>Applied Rules & Actions
                </h5>
            </div>
            <div class="card-body">
                {% if actions %}
                    {% for action in actions %}
                        <div class="border rounded p-2 mb-2 {{ 'border-success' if action.action == 'allow' else 'border-danger' if action.action == 'block' else 'border-warning' }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="badge bg-{{ 'success' if action.action == 'allow' else 'danger' if action.action == 'block' else 'warning' }}">
                                    {{ action.action.title() }}
                                </span>
                                <small class="text-muted">Priority: {{ action.priority }}</small>
                            </div>
                            <div class="mt-1">
                                {% if action.type == 'rule' %}
                                    <strong>{{ action.rule_name }}</strong>
                                {% elif action.type == 'whitelist' %}
                                    <strong>Whitelist</strong>
                                {% elif action.type == 'keyword' %}
                                    <strong>Keywords</strong>
                                {% elif action.type == 'exclusion' %}
                                    <strong>Exclusion Keywords</strong>
                                {% else %}
                                    <strong>{{ action.rule_name or 'Unknown Action' }}</strong>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ action.reason }}</small>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No rules applied to this event</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Whitelist Status -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>Whitelist Status
                </h5>
            </div>
            <div class="card-body">
                {% if whitelist_matches %}
                    {% for match in whitelist_matches %}
                        <div class="border rounded p-2 mb-2 border-success bg-light">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>Whitelisted
                                </span>
                                <small class="text-muted">{{ match.type.title() }}</small>
                            </div>
                            <div class="mt-1">
                                <strong>{{ match.value }}</strong>
                            </div>
                            <small class="text-muted">{{ match.reason }}</small>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-times-circle fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No whitelist matches</p>
                    </div>
                {% endif %}
            </div>
        </div>


    </div>
</div>

<!-- Event Details Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="eventDetailTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="recipients-tab" data-bs-toggle="tab" data-bs-target="#recipients" type="button" role="tab">
                            <i class="fas fa-users me-2"></i>Recipients ({{ recipients|length }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="attachments-tab" data-bs-toggle="tab" data-bs-target="#attachments" type="button" role="tab">
                            <i class="fas fa-paperclip me-2"></i>Attachments ({{ attachments|length }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="policies-tab" data-bs-toggle="tab" data-bs-target="#policies" type="button" role="tab">
                            <i class="fas fa-shield-alt me-2"></i>Policies ({{ policies|length }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="keywords-tab" data-bs-toggle="tab" data-bs-target="#keywords" type="button" role="tab">
                            <i class="fas fa-tags me-2"></i>Keyword Matches ({{ keyword_matches|length }})
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="eventDetailTabsContent">
                    <!-- Recipients Tab -->
                    <div class="tab-pane fade show active" id="recipients" role="tabpanel">
                        {% if recipients %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Email Address</th>
                                            <th>Domain</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for recipient in recipients %}
                                            <tr>
                                                <td><code>{{ recipient }}</code></td>
                                                <td>
                                                    {% if '@' in recipient %}
                                                        <span class="badge bg-secondary">{{ recipient.split('@')[1] }}</span>
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No recipients listed</h5>
                                <p class="text-muted mb-0">This event does not have any recipients recorded.</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Attachments Tab -->
                    <div class="tab-pane fade" id="attachments" role="tabpanel">
                        {% if attachments %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Filename</th>
                                            <th>Type</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for attachment in attachments %}
                                            <tr>
                                                <td>
                                                    <i class="fas fa-file me-2"></i>
                                                    <code>{{ attachment }}</code>
                                                </td>
                                                <td>
                                                    {% if '.' in attachment %}
                                                        <span class="badge bg-info">{{ attachment.split('.')[-1].upper() }}</span>
                                                    {% else %}
                                                        <span class="text-muted">Unknown</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-paperclip fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No attachments</h5>
                                <p class="text-muted mb-0">This email does not contain any attachments.</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Policies Tab -->
                    <div class="tab-pane fade" id="policies" role="tabpanel">
                        {% if policies %}
                            <div class="row">
                                {% for policy in policies %}
                                    <div class="col-md-6 col-lg-4 mb-3">
                                        <div class="card border-secondary">
                                            <div class="card-body text-center">
                                                <i class="fas fa-shield-alt fa-2x text-secondary mb-2"></i>
                                                <h6 class="card-title">{{ policy }}</h6>
                                                <span class="badge bg-secondary">Policy</span>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No policies specified</h5>
                                <p class="text-muted mb-0">This event does not have any security policies applied.</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Keyword Matches Tab -->
                    <div class="tab-pane fade" id="keywords" role="tabpanel">
                        {% if keyword_matches %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>{{ keyword_matches|length }} keyword match(es) found</strong> - This event contains content that matches your configured keywords. Review carefully for potential security concerns.
                            </div>

                            <div class="card mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-search me-2"></i>Keyword Matches 
                                        <span class="badge bg-warning text-dark ms-2">{{ keyword_matches|length }}</span>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Type</th>
                                                    <th>Keyword/Pattern</th>
                                                    <th>Found In</th>
                                                    <th>Match Type</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for match in keyword_matches %}
                                                <tr>
                                                    <td>
                                                        <span class="badge bg-primary">{{ match.type }}</span>
                                                    </td>
                                                    <td>
                                                        <span class="text-white bg-dark px-2 py-1 rounded font-monospace">{{ match.term }}</span>
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-success">{{ match.location }}</span>
                                                    </td>
                                                    <td>{{ match.match_type }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No keyword matches found</h5>
                                <p class="text-muted mb-0">This event does not contain any content matching your configured keywords.</p>
                            </div>
                        {% endif %}

                        <!-- Domain Classification -->
                        <div class="card mt-3" id="domainClassificationCard">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-globe me-2"></i>Domain Analysis
                                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadDomainClassification({{ event.id }})">
                                        <i class="fas fa-sync"></i> Analyze Domains
                                    </button>
                                </h6>
                            </div>
                            <div class="card-body" id="domainClassificationContent">
                                <div class="text-center py-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span class="text-muted">Click "Analyze Domains" to classify recipient domains</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Event Management -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>Event Management
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>Current Status</h6>
                        {% if event.is_whitelisted %}
                            <span class="badge bg-success fs-6">
                                <i class="fas fa-check-circle me-1"></i>Whitelisted
                            </span>
                        {% elif event.follow_up %}
                            <span class="badge bg-warning fs-6">
                                <i class="fas fa-flag me-1"></i>Follow-up Required
                            </span>
                        {% elif event.status == 'closed' %}
                            <span class="badge bg-secondary fs-6">
                                <i class="fas fa-archive me-1"></i>Closed
                            </span>
                        {% else %}
                            <span class="badge bg-primary fs-6">
                                <i class="fas fa-folder-open me-1"></i>Open
                            </span>
                        {% endif %}
                    </div>

                    <div class="col-md-8">
                        <h6>Actions</h6>
                        <div class="btn-group" role="group">
                            {% if not event.is_whitelisted %}
                                <form method="POST" action="{{ url_for('update_event_status', event_id=event.id) }}" class="d-inline">
                                    <input type="hidden" name="action" value="whitelist">
                                    <button type="submit" class="btn btn-sm btn-success">
                                        <i class="fas fa-check-circle me-1"></i>Whitelist
                                    </button>
                                </form>
                            {% endif %}

                            {% if not event.follow_up and event.status != 'closed' %}
                                <form method="POST" action="{{ url_for('update_event_status', event_id=event.id) }}" class="d-inline">
                                    <input type="hidden" name="action" value="follow_up">
                                    <button type="submit" class="btn btn-sm btn-warning">
                                        <i class="fas fa-flag me-1"></i>Mark for Follow-up
                                    </button>
                                </form>
                            {% elif event.follow_up %}
                                <!-- Generate Email button for follow-up events -->
                                <a href="mailto:{{ event.sender }}?subject=Data Security Review - Re: {{ event.subject | urlencode }}&body=Hi,%0D%0A%0D%0AI hope you're doing well. I'm following up regarding an email you recently sent on {{ event._time[:10] }}, which included {% if event.attachments %}{% if event.attachments|length == 1 %}an attachment titled:%0D%0A{{ event.attachments[0] | urlencode }}{% else %}attachments titled:%0D%0A{% for attachment in event.attachments %}{{ attachment | urlencode }}%0D%0A{% endfor %}{% endif %}{% else %}an attachment titled:%0D%0A[attachment name]{% endif %}.%0D%0A%0D%0AAs part of our standard data security review, I'd like to confirm a few details about the purpose of the email and the nature of the attachment{% if event.attachments and event.attachments|length > 1 %}s{% endif %}. Could you please provide some context around the recipient and the content of the file{% if event.attachments and event.attachments|length > 1 %}s{% endif %}?%0D%0A%0D%0AYour clarification will help us ensure everything is in line with policy and support our ongoing efforts to protect sensitive information.%0D%0A%0D%0AThank you for your time and cooperation. Please let me know if you'd prefer to discuss this over a quick call.%0D%0A%0D%0ABest regards"</a> 
                                   class="btn btn-sm btn-info"
                                   onclick="setTimeout(() => { 
                                       if(confirm('Mark this email as sent?')) {
                                           document.getElementById('markSentForm').submit();
                                       }
                                   }, 1000);">
                                    <i class="fas fa-envelope me-1"></i>Generate Email
                                </a>

                                <!-- Hidden form to mark email as sent -->
                                <form method="POST" action="{{ url_for('update_event_status', event_id=event.id) }}" 
                                      id="markSentForm" style="display: none;">
                                    <input type="hidden" name="action" value="mark_email_sent">
                                </form>

                                {% if event.email_sent %}
                                    <span class="badge bg-info ms-2" title="Email sent on {{ event.email_sent_date }}">
                                        <i class="fas fa-paper-plane me-1"></i>Email Sent
                                    </span>
                                {% endif %}
                            {% endif %}

                            {% if event.status != 'closed' %}
                                <form method="POST" action="{{ url_for('update_event_status', event_id=event.id) }}" class="d-inline">
                                    <input type="hidden" name="action" value="close">
                                    <button type="submit" class="btn btn-sm btn-secondary">
                                        <i class="fas fa-archive me-1"></i>Close Event
                                    </button>
                                </form>
                            {% endif %}

                            {% if event.status == 'closed' %}
                                <form method="POST" action="{{ url_for('update_event_status', event_id=event.id) }}" class="d-inline">
                                    <input type="hidden" name="action" value="reopen">
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="fas fa-folder-open me-1"></i>Reopen Event
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function loadDomainClassification(eventId) {
    const content = document.getElementById('domainClassificationContent');

    // Clear any existing content and show loading
    content.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm me-2"></div>
            <span>Analyzing domains...</span>
        </div>
    `;

    fetch(`/api/classify_domains/${eventId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDomainClassifications(data.domain_classifications, data.domain_risk_score);
            } else {
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error analyzing domains: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            content.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Network error: ${error.message}
                </div>
            `;
        });
}

function displayDomainClassifications(classifications, riskScore) {
    const content = document.getElementById('domainClassificationContent');

    if (!classifications || classifications.length === 0) {
        content.innerHTML = `
            <div class="text-center py-3">
                <i class="fas fa-info-circle me-2"></i>
                <span class="text-muted">No domains to classify</span>
            </div>
        `;
        return;
    }

    const labelColors = {
        'internal': 'success',
        'freemail': 'primary', 
        'partner': 'info',
        'suspicious': 'danger',
        'unknown': 'secondary'
    };

    const labelIcons = {
        'internal': 'building',
        'freemail': 'envelope',
        'partner': 'handshake', 
        'suspicious': 'exclamation-triangle',
        'unknown': 'question'
    };

    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Domain Classifications</h6>
            <div>
                <span class="badge bg-${riskScore > 0.6 ? 'danger' : riskScore > 0.3 ? 'warning' : 'success'}">
                    Risk Score: ${(riskScore * 100).toFixed(1)}%
                </span>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Domain</th>
                        <th>Classification</th>
                        <th>Confidence</th>
                    </tr>
                </thead>
                <tbody>
    `;

    classifications.forEach(classification => {
        const color = labelColors[classification.label] || 'secondary';
        const icon = labelIcons[classification.label] || 'question';

        html += `
            <tr>
                <td><code>${classification.email}</code></td>
                <td><code>${classification.domain}</code></td>
                <td>
                    <span class="badge bg-${color}">
                        <i class="fas fa-${icon} me-1"></i>
                        ${classification.label.charAt(0).toUpperCase() + classification.label.slice(1)}
                    </span>
                </td>
                <td>
                    <div class="progress" style="width: 80px; height: 20px;">
                        <div class="progress-bar bg-${color}" role="progressbar" 
                             style="width: ${(classification.confidence * 100).toFixed(0)}%">
                            ${(classification.confidence * 100).toFixed(0)}%
                        </div>
                    </div>
                </td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
        </div>
    `;

    content.innerHTML = html;
}
</script>
{% endblock %}