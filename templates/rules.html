{% extends "base.html" %}

{% block title %}Rules Management - Email Guardian{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-gavel me-2"></i>Rules Management
        </h1>
    </div>
</div>

<!-- Rule Builder -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plus me-2"></i>Build New Rule
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="ruleForm">
                    <input type="hidden" name="action" value="add">

                    <!-- Basic Rule Info -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="name" class="form-label">Rule Name *</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="rule_action" class="form-label">Action *</label>
                                <select class="form-select" id="rule_action" name="rule_action" required>
                                    <option value="">Select action...</option>
                                    <option value="allow">Allow</option>
                                    <option value="block">Block</option>
                                    <option value="escalate">Escalate</option>
                                    <option value="flag">Flag</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority</label>
                                <input type="number" class="form-control" id="priority" name="priority" 
                                       value="100" min="1" max="1000">
                                <div class="form-text">Lower numbers = higher priority</div>
                            </div>
                        </div>
                    </div>

                    <!-- Rule Conditions -->
                    <div class="mb-4">
                        <h6>Rule Conditions</h6>
                        <div id="conditions-container">
                            <div class="condition-group border rounded p-3 mb-3" data-condition="0">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <select class="form-select condition-field" name="conditions[0][field]">
                                            <option value="">Select field...</option>
                                            <option value="sender">Sender Email</option>
                                            <option value="sender_domain">Sender Domain</option>
                                            <option value="subject">Subject</option>
                                            <option value="keywords">Keywords (Subject & Attachments)</option>
                                            <option value="recipients">Recipients</option>
                                            <option value="recipient_domain">Recipient Domain</option>
                                            <option value="ml_score">ML Score</option>
                                            <option value="is_internal_to_external">Internal to External</option>
                                            <option value="bunit">Business Unit</option>
                                            <option value="department">Department</option>
                                            <option value="leaver">Is Leaver</option>
                                            <option value="termination_date">Termination Date</option>
                                            <option value="attachments">Attachments</option>
                                            <option value="policies">Policy Names</option>
                                            <option value="domain_risk_score">Domain Risk Score</option>
                                            <option value="sender_domain_classification">Sender Domain Classification</option>
                                            <option value="recipient_domain_classifications">Recipient Domain Classifications</option>
                                            <option value="has_suspicious_domains">Has Suspicious Domains</option>
                                            <option value="has_external_domains">Has External Domains</option></option>
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select condition-operator" name="conditions[0][operator]">
                                            <option value="equals">Equals</option>
                                            <option value="contains">Contains</option>
                                            <option value="starts_with">Starts With</option>
                                            <option value="ends_with">Ends With</option>
                                            <option value="matches">Matches Pattern</option>
                                            <option value="greater_than">Greater Than</option>
                                            <option value="less_than">Less Than</option>
                                            <option value="is_true">Is True</option>
                                            <option value="is_false">Is False</option>
                                            <option value="is_empty">Is Empty</option>
                                            <option value="is_not_empty">Is Not Empty</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control condition-value" 
                                               name="conditions[0][value]" placeholder="Enter value...">
                                    </div>
                                    <div class="col-md-2">
                                        <select class="form-select condition-logic" name="conditions[0][logic]">
                                            <option value="AND">AND</option>
                                            <option value="OR">OR</option>
                                        </select>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="btn btn-danger btn-sm remove-condition">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-outline-primary btn-sm add-condition-btn">
                            <i class="fas fa-plus me-2"></i>Add Condition
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="resetForm()">
                            <i class="fas fa-refresh me-2"></i>Reset Form
                        </button>
                    </div>

                    <!-- Rule Status and Submit -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enabled" name="enabled" checked>
                                <label class="form-check-label" for="enabled">
                                    Enabled
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button type="button" class="btn btn-outline-info me-2" id="testRuleBtn">
                                <i class="fas fa-flask me-2"></i>Test Rule
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create Rule
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Test Results Section (initially hidden) -->
<div class="row mb-4" id="testResultsSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-flask me-2"></i>Rule Test Results
                </h5>
            </div>
            <div class="card-body" id="testResultsContent">
                <!-- Test results will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Existing Rules -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Existing Rules ({{ rules|length }})
                </h5>
            </div>
            <div class="card-body">
                {% if rules %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Priority</th>
                                    <th>Name</th>
                                    <th>Action</th>
                                    <th>Conditions</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rule in rules %}
                                    <tr class="{{ 'table-secondary' if not rule.enabled else '' }}" data-rule-id="{{ rule.id }}">
                                        <td>
                                            <span class="badge bg-secondary">{{ rule.priority }}</span>
                                        </td>
                                        <td>
                                            <strong>{{ rule.name }}</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if rule.action == 'allow' else 'danger' if rule.action == 'block' else 'warning' }}">
                                                {{ rule.action.title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <small>
                                                {% if rule.conditions_json %}
                                                    {{ rule.conditions_summary }}
                                                {% else %}
                                                    <em class="text-muted">No conditions set</em>
                                                {% endif %}
                                            </small>
                                        </td>
                                        <td>
                                            {% if rule.enabled %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>Enabled
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-pause me-1"></i>Disabled
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <!-- Toggle Enable/Disable -->
                                            <form method="POST" class="d-inline">
                                                <input type="hidden" name="action" value="toggle">
                                                <input type="hidden" name="rule_id" value="{{ rule.id }}">
                                                <input type="hidden" name="enabled" value="{{ 'false' if rule.enabled else 'true' }}">
                                                <button type="submit" class="btn btn-sm btn-outline-{{ 'warning' if rule.enabled else 'success' }}" 
                                                        title="{{ 'Disable' if rule.enabled else 'Enable' }} rule">
                                                    <i class="fas fa-{{ 'pause' if rule.enabled else 'play' }}"></i>
                                                </button>
                                            </form>

                                            <!-- Delete -->
                                            <form method="POST" class="d-inline" 
                                                  onsubmit="return confirm('Are you sure you want to delete this rule?')">
                                                <input type="hidden" name="action" value="delete">
                                                <input type="hidden" name="rule_id" value="{{ rule.id }}">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete rule">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>

                                            <!-- Edit Button -->
                                            <button type="button" class="btn btn-sm btn-outline-primary edit-rule-btn" 
                                                    title="Edit rule"
                                                    data-rule-id="{{ rule.id }}"
                                                    data-rule-name="{{ rule.name }}"
                                                    data-rule-action="{{ rule.action }}"
                                                    data-rule-priority="{{ rule.priority }}"
                                                    data-rule-enabled="{{ rule.enabled }}"
                                                    data-rule-conditions="{{ rule.conditions_json | default('[]') | tojson }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-gavel fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No rules configured</h5>
                        <p class="text-muted">Create your first rule using the form above.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Field Reference -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Field Reference & Rule Guide
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Available Fields</h6>
                        <ul>
                            <li><strong>Sender Email:</strong> Full sender email address</li>
                            <li><strong>Sender Domain:</strong> Domain part of sender email</li>
                            <li><strong>Sender Domain Classification:</strong> ML classification of sender domain (e.g., 'trusted', 'suspicious', 'unknown')</li>
                            <li><strong>Subject:</strong> Email subject line</li>
                            <li><strong>Keywords:</strong> Matches against configured keywords in subject/attachments</li>
                            <li><strong>Recipients:</strong> List of recipient emails</li>
                            <li><strong>Recipient Domain:</strong> Domain of recipients</li>
                            <li><strong>Recipient Domain Classifications:</strong> ML classification of recipient domains</li>
                            <li><strong>Domain Risk Score:</strong> ML-derived risk score for domains</li>
                            <li><strong>Has Suspicious Domains:</strong> Boolean - if any recipient domain is flagged as suspicious</li>
                            <li><strong>Has External Domains:</strong> Boolean - if any recipient domain is external to the organization</li>
                            <li><strong>Business Unit:</strong> Sender's business unit</li>
                            <li><strong>Department:</strong> Sender's department</li>
                            <li><strong>Is Leaver:</strong> Boolean - if sender is leaving</li>
                            <li><strong>Termination Date:</strong> Employee termination date</li>
                            <li><strong>Attachments:</strong> List of attachment filenames</li>
                            <li><strong>Policy Names:</strong> Triggered security policies</li>
                            <li><strong>ML Score:</strong> Risk score (0.0 to 1.0)</li>
                            <li><strong>Internal to External:</strong> Boolean - internal sender to external recipient</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Operators</h6>
                        <ul>
                            <li><strong>Equals:</strong> Exact match</li>
                            <li><strong>Contains:</strong> Field contains value</li>
                            <li><strong>Starts With:</strong> Field starts with value</li>
                            <li><strong>Ends With:</strong> Field ends with value</li>
                            <li><strong>Matches Pattern:</strong> Wildcard matching (*, ?)</li>
                            <li><strong>Greater/Less Than:</strong> Numeric comparison</li>
                            <li><strong>Is True/False:</strong> Boolean values</li>
                            <li><strong>Is Empty/Not Empty:</strong> Field presence</li>
                        </ul>

                        <h6>Logic</h6>
                        <ul>
                            <li><strong>AND:</strong> All conditions must match</li>
                            <li><strong>OR:</strong> Any condition can match</li>
                            <li>Conditions are evaluated left to right</li>
                            <li>Use parentheses for complex logic grouping</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let conditionCounter = 0; // Initialize to 0 to properly index for new conditions

// Function to add a new condition row
function addCondition() {
    const container = document.getElementById('conditions-container');
    const newCondition = document.createElement('div');
    newCondition.className = 'condition-group border rounded p-3 mb-3';
    newCondition.setAttribute('data-condition', conditionCounter);

    newCondition.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-3">
                <select class="form-select condition-field" name="conditions[${conditionCounter}][field]">
                    <option value="">Select field...</option>
                    <option value="sender">Sender Email</option>
                    <option value="sender_domain">Sender Domain</option>
                    <option value="sender_domain_classification">Sender Domain Classification</option>
                    <option value="subject">Subject</option>
                    <option value="keywords">Keywords (Subject & Attachments)</option>
                    <option value="recipients">Recipients</option>
                    <option value="recipient_domain">Recipient Domain</option>
                    <option value="recipient_domain_classifications">Recipient Domain Classifications</option>
                    <option value="domain_risk_score">Domain Risk Score</option>
                    <option value="has_suspicious_domains">Has Suspicious Domains</option>
                    <option value="has_external_domains">Has External Domains</option>
                    <option value="bunit">Business Unit</option>
                    <option value="department">Department</option>
                    <option value="leaver">Is Leaver</option>
                    <option value="termination_date">Termination Date</option>
                    <option value="attachments">Attachments</option>
                    <option value="policies">Policy Names</option>
                    <option value="ml_score">ML Score</option>
                    <option value="is_internal_to_external">Internal to External</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select condition-operator" name="conditions[${conditionCounter}][operator]">
                    <option value="equals">Equals</option>
                    <option value="contains">Contains</option>
                    <option value="starts_with">Starts With</option>
                    <option value="ends_with">Ends With</option>
                    <option value="matches">Matches Pattern</option>
                    <option value="is_empty">Is Empty</option>
                    <option value="is_not_empty">Is Not Empty</option>
                </select>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control condition-value" 
                       name="conditions[${conditionCounter}][value]" placeholder="Enter value...">
            </div>
            <div class="col-md-2">
                <select class="form-select condition-logic" name="conditions[${conditionCounter}][logic]">
                    <option value="AND">AND</option>
                    <option value="OR">OR</option>
                </select>
            </div>
            <div class="col-md-1">
                 <div class="form-check">
                    <input class="form-check-input condition-negate" type="checkbox" 
                           name="conditions[${conditionCounter}][negate]" title="Exclude/NOT condition">
                    <label class="form-check-label text-danger" title="Exclude this condition">
                        <small>NOT</small>
                    </label>
                </div>
            </div>
        </div>
    `;

    container.appendChild(newCondition);
    conditionCounter++;
}

// Function to remove a condition row
function removeCondition(conditionId) {
    const condition = document.querySelector(`[data-condition="${conditionId}"]`);
    const container = document.getElementById('conditions-container');

    if (condition && container) {
        // Don't allow removing the last condition if it's the only one
        const allConditions = container.querySelectorAll('.condition-group');

        if (allConditions.length > 1) {
            condition.remove();
            // Re-index the remaining conditions
            updateConditionIndices();
        } else {
            // If it's the last condition, clear its values instead of removing it
            const selects = condition.querySelectorAll('select');
            const inputs = condition.querySelectorAll('input');

            selects.forEach(select => select.selectedIndex = 0);
            inputs.forEach(input => input.value = '');
            // Also reset the negate checkbox
            const checkbox = condition.querySelector('.condition-negate');
            if(checkbox) checkbox.checked = false;
        }
    }
}

// Helper function to re-index condition inputs after removal
function updateConditionIndices() {
    const conditionGroups = document.querySelectorAll('.condition-group');
    conditionGroups.forEach((group, index) => {
        group.setAttribute('data-condition', index);
        const inputs = group.querySelectorAll('input, select');
        inputs.forEach(input => {
            const name = input.getAttribute('name');
            if (name && name.includes('[')) {
                const newName = name.replace(/conditions\[\d+\]/, `conditions[${index}]`);
                input.setAttribute('name', newName);
            }
        });
    });
    conditionCounter = conditionGroups.length; // Ensure counter is up-to-date
}

// Update operator options based on field selection
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('condition-field')) {
        const field = e.target.value;
        const operatorSelect = e.target.closest('.row').querySelector('.condition-operator');
        const valueInput = e.target.closest('.row').querySelector('.condition-value');
        const negateCheckbox = e.target.closest('.row').querySelector('.condition-negate');

        // Reset operator options
        operatorSelect.innerHTML = '';

        // Define options for each field type
        const operatorOptionsMap = {
            "sender": [
                { value: "equals", text: "Equals" },
                { value: "contains", text: "Contains" },
                { value: "starts_with", text: "Starts With" },
                { value: "ends_with", text: "Ends With" },
                { value: "matches", text: "Matches Pattern" },
                { value: "is_empty", text: "Is Empty" },
                { value: "is_not_empty", text: "Is Not Empty" }
            ],
            "sender_domain": [
                { value: "equals", text: "Equals" },
                { value: "contains", text: "Contains" },
                { value: "starts_with", text: "Starts With" },
                { value: "ends_with", text: "Ends With" },
                { value: "matches", text: "Matches Pattern" },
                { value: "is_empty", text: "Is Empty" },
                { value: "is_not_empty", text: "Is Not Empty" }
            ],
            "sender_domain_classification": [
                { value: "equals", text: "Equals" },
                { value: "contains", text: "Contains" },
                { value: "is_empty", text: "Is Empty" },
                { value: "is_not_empty", text: "Is Not Empty" }
            ],
            "recipient_domain": [
                { value: "equals", text: "Equals" },
                { value: "contains", text: "Contains" },
                { value: "starts_with", text: "Starts With" },
                { value: "ends_with", text: "Ends With" },
                { value: "matches", text: "Matches Pattern" },
                { value: "is_empty", text: "Is Empty" },
                { value: "is_not_empty", text: "Is Not Empty" }
            ],
            "recipient_domain_classifications": [
                { value: "equals", text: "Equals" },
                { value: "contains", text: "Contains" },
                { value: "is_empty", text: "Is Empty" },
                { value: "is_not_empty", text: "Is Not Empty" }
            ],
            "domain_risk_score": [
                { value: "equals", text: "Equals" },
                { value: "greater_than", text: "Greater Than" },
                { value: "less_than", text: "Less Than" }
            ],
            "has_suspicious_domains": [
                { value: "is_true", text: "Is True" },
                { value: "is_false", text: "Is False" }
            ],
            "has_external_domains": [
                { value: "is_true", text: "Is True" },
                { value: "is_false", text: "Is False" }
            ],
            "subject": [
                { value: "equals", text: "Equals" },
                { value: "contains", text: "Contains" },
                { value: "starts_with", text: "Starts With" },
                { value: "ends_with", text: "Ends With" },
                { value: "matches", text: "Matches Pattern" },
                { value: "is_empty", text: "Is Empty" },
                { value: "is_not_empty", text: "Is Not Empty" }
            ],
            "keywords": [
                { value: "contains", text: "Contains Keyword" },
                { value: "is_not_empty", text: "Has Any Keywords" },
                { value: "is_empty", text: "No Keywords Match" }
            ],
            "recipients": [
                { value: "contains", text: "Contains Email" },
                { value: "matches", text: "Matches Pattern" },
                { value: "is_empty", text: "Is Empty" },
                { value: "is_not_empty", text: "Is Not Empty" }
            ],
            "bunit": [
                { value: "equals", text: "Equals" },
                { value: "contains", text: "Contains" },
                { value: "is_empty", text: "Is Empty" },
                { value: "is_not_empty", text: "Is Not Empty" }
            ],
            "department": [
                { value: "equals", text: "Equals" },
                { value: "contains", text: "Contains" },
                { value: "is_empty", text: "Is Empty" },
                { value: "is_not_empty", text: "Is Not Empty" }
            ],
            "leaver": [
                { value: "is_true", text: "Is True" },
                { value: "is_false", text: "Is False" }
            ],
            "termination_date": [
                { value: "before", text: "Before Date" },
                { value: "after", text: "After Date" },
                { value: "on", text: "On Date" }
            ],
            "attachments": [
                { value: "contains", text: "Contains Filename" },
                { value: "matches", text: "Matches Pattern" },
                { value: "is_empty", text: "Is Empty" },
                { value: "is_not_empty", text: "Is Not Empty" }
            ],
            "policies": [
                { value: "contains", text: "Contains Policy" },
                { value: "matches", text: "Matches Pattern" },
                { value: "is_empty", text: "Is Empty" },
                { value: "is_not_empty", text: "Is Not Empty" }
            ],
            "ml_score": [
                { value: "equals", text: "Equals" },
                { value: "greater_than", text: "Greater Than" },
                { value: "less_than", text: "Less Than" }
            ],
            "is_internal_to_external": [
                { value: "is_true", text: "Is True" },
                { value: "is_false", text: "Is False" }
            ]
        };

        // Helper to generate options with selected attribute
        const generateOptions = (options, selectedValue) => {
            return options.map(({ value, text }) => `<option value="${value}" ${value === selectedValue ? 'selected' : ''}>${text}</option>`).join('');
        };

        const currentOperators = operatorOptionsMap[field] || operatorOptionsMap["sender"]; // Default to sender if field not found
        operatorSelect.innerHTML = generateOptions(currentOperators, ''); // Set initial operator to default

        // Update value input type and visibility
        if (['ml_score', 'domain_risk_score'].includes(field)) {
            valueInput.type = 'number';
            valueInput.step = '0.01';
            valueInput.style.display = 'block';
        } else if (['leaver', 'is_internal_to_external'].includes(field) || ['has_suspicious_domains', 'has_external_domains'].includes(field)) {
            valueInput.style.display = 'none';
            // Ensure operator is set to is_true or is_false if available
            if (!currentOperators.some(opt => opt.value === operatorSelect.value)) {
                 operatorSelect.value = 'is_true'; // default to is_true
            }
        } else if (field === 'keywords') {
            valueInput.type = 'text';
            valueInput.style.display = 'block';
            valueInput.placeholder = 'Enter keyword term to match...';
        } else if (field === 'sender_domain_classification' || field === 'recipient_domain_classifications') {
            valueInput.type = 'text';
            valueInput.style.display = 'block';
            valueInput.placeholder = 'Enter classification (e.g., trusted, suspicious)';
        }
         else if (field === 'termination_date') {
            valueInput.type = 'date';
            valueInput.style.display = 'block';
        }
        else {
            valueInput.type = 'text';
            valueInput.style.display = 'block';
            valueInput.placeholder = 'Enter value...';
        }
        
        // Handle negate checkbox visibility
        if (['leaver', 'is_internal_to_external'].includes(field) || ['has_suspicious_domains', 'has_external_domains'].includes(field)) {
             negateCheckbox.closest('.form-check').style.display = 'none';
        } else {
            negateCheckbox.closest('.form-check').style.display = 'block';
        }
    }
});

// Function to populate form for editing
function editRule(ruleId, name, action, priority, enabled, conditions) {
    // Clear any existing edit state first
    resetForm();

    // Highlight the rule being edited
    highlightEditingRule(ruleId);

    // Populate the form with existing rule data
    const nameElement = document.getElementById('name');
    const actionElement = document.getElementById('rule_action');
    const priorityElement = document.getElementById('priority');
    const enabledElement = document.getElementById('enabled');

    if (nameElement) nameElement.value = name;
    if (actionElement) actionElement.value = action;
    if (priorityElement) priorityElement.value = priority;
    if (enabledElement) enabledElement.checked = enabled;

    // Change form action to edit
    const form = document.getElementById('ruleForm');
    const actionInput = form.querySelector('input[name="action"]');

    if (actionInput) {
        actionInput.value = 'edit';
    }

    // Add rule ID for editing
    let ruleIdInput = form.querySelector('input[name="rule_id"]');
    if (!ruleIdInput) {
        ruleIdInput = document.createElement('input');
        ruleIdInput.type = 'hidden';
        ruleIdInput.name = 'rule_id';
        form.appendChild(ruleIdInput);
    }
    ruleIdInput.value = ruleId;

    // Clear existing conditions and populate from data
    const container = document.getElementById('conditions-container');
    if (container) {
        container.innerHTML = '';
        conditionCounter = 0; // Reset counter for new conditions

        if (conditions && Array.isArray(conditions) && conditions.length > 0) {
            conditions.forEach((condition, index) => {
                addConditionWithData(
                    condition.field || '', 
                    condition.operator || 'equals', 
                    condition.value || '', 
                    condition.logic || 'AND',
                    condition.negate || false // Pass the negate value
                );
            });
        } else {
            // Add one empty condition if no conditions exist
            addCondition();
        }
    }

    // Update submit button text
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Rule';
    }

    // Add cancel button if it doesn't exist
    addCancelButton();

    // Add visual indicator that we're editing
    addEditingIndicator(name);

    // Scroll to form
    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
}


// Function to add a condition with pre-filled data, including negate status
function addConditionWithData(field = '', operator = 'equals', value = '', logic = 'AND', negate = false) {
    const container = document.getElementById('conditions-container');
    const newCondition = document.createElement('div');
    newCondition.className = 'condition-group border rounded p-3 mb-3';
    newCondition.setAttribute('data-condition', conditionCounter);

    // Helper to generate options with selected attribute
    const generateOptions = (options, selectedValue) => {
        return options.map(({ value, text }) => `<option value="${value}" ${value === selectedValue ? 'selected' : ''}>${text}</option>`).join('');
    };

    // Define options for each field type
    const fieldOptions = [
        { value: "", text: "Select field..." },
        { value: "sender", text: "Sender Email" },
        { value: "sender_domain", text: "Sender Domain" },
        { value: "sender_domain_classification", text: "Sender Domain Classification" },
        { value: "subject", text: "Subject" },
        { value: "keywords", text: "Keywords (Subject & Attachments)" },
        { value: "recipients", text: "Recipients" },
        { value: "recipient_domain", text: "Recipient Domain" },
        { value: "recipient_domain_classifications", text: "Recipient Domain Classifications" },
        { value: "domain_risk_score", text: "Domain Risk Score" },
        { value: "has_suspicious_domains", text: "Has Suspicious Domains" },
        { value: "has_external_domains", text: "Has External Domains" },
        { value: "bunit", text: "Business Unit" },
        { value: "department", text: "Department" },
        { value: "leaver", text: "Is Leaver" },
        { value: "termination_date", text: "Termination Date" },
        { value: "attachments", text: "Attachments" },
        { value: "policies", text: "Policy Names" },
        { value: "ml_score", text: "ML Score" },
        { value: "is_internal_to_external", text: "Internal to External" },
    ];

    const operatorOptionsMap = {
        "sender": [
            { value: "equals", text: "Equals" },
            { value: "contains", text: "Contains" },
            { value: "starts_with", text: "Starts With" },
            { value: "ends_with", text: "Ends With" },
            { value: "matches", text: "Matches Pattern" },
            { value: "is_empty", text: "Is Empty" },
            { value: "is_not_empty", text: "Is Not Empty" }
        ],
        "sender_domain": [
            { value: "equals", text: "Equals" },
            { value: "contains", text: "Contains" },
            { value: "starts_with", text: "Starts With" },
            { value: "ends_with", text: "Ends With" },
            { value: "matches", text: "Matches Pattern" },
            { value: "is_empty", text: "Is Empty" },
            { value: "is_not_empty", text: "Is Not Empty" }
        ],
        "sender_domain_classification": [
            { value: "equals", text: "Equals" },
            { value: "contains", text: "Contains" },
            { value: "is_empty", text: "Is Empty" },
            { value: "is_not_empty", text: "Is Not Empty" }
        ],
        "recipient_domain": [
            { value: "equals", text: "Equals" },
            { value: "contains", text: "Contains" },
            { value: "starts_with", text: "Starts With" },
            { value: "ends_with", text: "Ends With" },
            { value: "matches", text: "Matches Pattern" },
            { value: "is_empty", text: "Is Empty" },
            { value: "is_not_empty", text: "Is Not Empty" }
        ],
        "recipient_domain_classifications": [
            { value: "equals", text: "Equals" },
            { value: "contains", text: "Contains" },
            { value: "is_empty", text: "Is Empty" },
            { value: "is_not_empty", text: "Is Not Empty" }
        ],
        "domain_risk_score": [
            { value: "equals", text: "Equals" },
            { value: "greater_than", text: "Greater Than" },
            { value: "less_than", text: "Less Than" }
        ],
        "has_suspicious_domains": [
            { value: "is_true", text: "Is True" },
            { value: "is_false", text: "Is False" }
        ],
        "has_external_domains": [
            { value: "is_true", text: "Is True" },
            { value: "is_false", text: "Is False" }
        ],
        "subject": [
            { value: "equals", text: "Equals" },
            { value: "contains", text: "Contains" },
            { value: "starts_with", text: "Starts With" },
            { value: "ends_with", text: "Ends With" },
            { value: "matches", text: "Matches Pattern" },
            { value: "is_empty", text: "Is Empty" },
            { value: "is_not_empty", text: "Is Not Empty" }
        ],
        "keywords": [
            { value: "contains", text: "Contains Keyword" },
            { value: "is_not_empty", text: "Has Any Keywords" },
            { value: "is_empty", text: "No Keywords Match" }
        ],
        "recipients": [
            { value: "contains", text: "Contains Email" },
            { value: "matches", text: "Matches Pattern" },
            { value: "is_empty", text: "Is Empty" },
            { value: "is_not_empty", text: "Is Not Empty" }
        ],
        "bunit": [
            { value: "equals", text: "Equals" },
            { value: "contains", text: "Contains" },
            { value: "is_empty", text: "Is Empty" },
            { value: "is_not_empty", text: "Is Not Empty" }
        ],
        "department": [
            { value: "equals", text: "Equals" },
            { value: "contains", text: "Contains" },
            { value: "is_empty", text: "Is Empty" },
            { value: "is_not_empty", text: "Is Not Empty" }
        ],
        "leaver": [
            { value: "is_true", text: "Is True" },
            { value: "is_false", text: "Is False" }
        ],
        "termination_date": [
            { value: "before", text: "Before Date" },
            { value: "after", text: "After Date" },
            { value: "on", text: "On Date" }
        ],
        "attachments": [
            { value: "contains", text: "Contains Filename" },
            { value: "matches", text: "Matches Pattern" },
            { value: "is_empty", text: "Is Empty" },
            { value: "is_not_empty", text: "Is Not Empty" }
        ],
        "policies": [
            { value: "contains", text: "Contains Policy" },
            { value: "matches", text: "Matches Pattern" },
            { value: "is_empty", text: "Is Empty" },
            { value: "is_not_empty", text: "Is Not Empty" }
        ],
        "ml_score": [
            { value: "equals", text: "Equals" },
            { value: "greater_than", text: "Greater Than" },
            { value: "less_than", text: "Less Than" }
        ],
        "is_internal_to_external": [
            { value: "is_true", text: "Is True" },
            { value: "is_false", text: "Is False" }
        ]
    };

    // Get the currently selected field to determine which operators to show
    const selectedField = field; // Use the passed field value directly
    const currentOperators = operatorOptionsMap[selectedField] || operatorOptionsMap["sender"]; // Default to sender if field not found
    const operatorOptionsHtml = generateOptions(currentOperators, operator);

    // Determine value input type and visibility based on selected field
    let valueInputType = 'text';
    let valueInputDisplay = 'block';
    let valueInputPlaceholder = 'Enter value...';

    if (['ml_score', 'domain_risk_score'].includes(selectedField)) {
        valueInputType = 'number';
        valueInputPlaceholder = 'Enter numeric value...';
    } else if (['leaver', 'is_internal_to_external'].includes(selectedField) || ['has_suspicious_domains', 'has_external_domains'].includes(selectedField)) {
        valueInputDisplay = 'none';
        // Ensure operator is set to is_true or is_false if available
        if (!currentOperators.some(opt => opt.value === operator)) {
            operator = 'is_true'; // default to is_true
        }
    } else if (selectedField === 'keywords') {
        valueInputPlaceholder = 'Enter keyword term to match...';
    } else if (selectedField === 'sender_domain_classification' || selectedField === 'recipient_domain_classifications') {
        valueInputPlaceholder = 'Enter classification (e.g., trusted, suspicious)';
    } else if (selectedField === 'termination_date') {
        valueInputType = 'date';
    }

    newCondition.innerHTML = `
        <div class="row align-items-center">
            <div class="col-md-3">
                <select class="form-select condition-field" name="conditions[${conditionCounter}][field]">
                    ${generateOptions(fieldOptions, field)}
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select condition-operator" name="conditions[${conditionCounter}][operator]">
                    ${operatorOptionsHtml}
                </select>
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control condition-value" 
                       name="conditions[${conditionCounter}][value]" 
                       placeholder="${valueInputPlaceholder}" 
                       value="${value}" 
                       style="display: ${valueInputDisplay};" 
                       type="${valueInputType}">
            </div>
            <div class="col-md-2">
                <select class="form-select condition-logic" name="conditions[${conditionCounter}][logic]">
                    <option value="AND" ${logic === 'AND' ? 'selected' : ''}>AND</option>
                    <option value="OR" ${logic === 'OR' ? 'selected' : ''}>OR</option>
                </select>
            </div>
            <div class="col-md-1">
                <div class="form-check">
                    <input class="form-check-input condition-negate" type="checkbox" 
                           name="conditions[${conditionCounter}][negate]" title="Exclude/NOT condition" ${negate ? 'checked' : ''}>
                    <label class="form-check-label text-danger" title="Exclude this condition">
                        <small>NOT</small>
                    </label>
                </div>
            </div>
        </div>
    `;

    container.appendChild(newCondition);
    conditionCounter++;
}


// Function to reset the form to its default state
function resetForm() {
    const form = document.getElementById('ruleForm');
    if (form) {
        form.reset();

        // Reset form action to add
        const actionInput = form.querySelector('input[name="action"]');
        if (actionInput) {
            actionInput.value = 'add';
        }

        // Remove rule_id input if it exists
        const ruleIdInput = form.querySelector('input[name="rule_id"]');
        if (ruleIdInput) {
            ruleIdInput.remove();
        }

        // Reset submit button text
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-plus me-2"></i>Create Rule';
        }

        // Remove cancel button if it exists
        removeCancelButton();

        // Remove editing indicator
        removeEditingIndicator();

        // Clear rule highlights
        clearRuleHighlights();

        // Reset conditions
        const container = document.getElementById('conditions-container');
        if (container) {
            container.innerHTML = '';
            conditionCounter = 0;
            addCondition(); // Add a single empty condition
        }
    }
}

// Function to add a cancel button for editing
function addCancelButton() {
    const form = document.getElementById('ruleForm');
    const submitBtn = form.querySelector('button[type="submit"]');

    // Check if cancel button already exists
    let cancelBtn = form.querySelector('.cancel-edit-btn');
    if (!cancelBtn) {
        cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'btn btn-secondary ms-2 cancel-edit-btn';
        cancelBtn.innerHTML = '<i class="fas fa-times me-2"></i>Cancel';
        cancelBtn.onclick = function() {
            resetForm();
        };

        // Insert after submit button
        submitBtn.parentNode.insertBefore(cancelBtn, submitBtn.nextSibling);
    }
}

// Function to remove the cancel button
function removeCancelButton() {
    const cancelBtn = document.querySelector('.cancel-edit-btn');
    if (cancelBtn) {
        cancelBtn.remove();
    }
}

// Function to add an indicator when editing a rule
function addEditingIndicator(ruleName) {
    // Remove existing indicator
    removeEditingIndicator();

    const form = document.getElementById('ruleForm');
    const indicator = document.createElement('div');
    indicator.className = 'alert alert-info mb-3 editing-indicator';
    indicator.innerHTML = `
        <i class="fas fa-edit me-2"></i>
        <strong>Editing Rule:</strong> ${ruleName}
        <button type="button" class="btn-close float-end" onclick="resetForm()"></button>
    `;

    // Insert at the top of the form
    form.insertBefore(indicator, form.firstChild);
}

// Function to remove the editing indicator
function removeEditingIndicator() {
    const indicator = document.querySelector('.editing-indicator');
    if (indicator) {
        indicator.remove();
    }
}

// Function to highlight the rule being edited in the table
function highlightEditingRule(ruleId) {
    // Remove existing highlights
    clearRuleHighlights();

    // Find and highlight the rule being edited
    const ruleRows = document.querySelectorAll('tr[data-rule-id]');
    ruleRows.forEach(row => {
        if (row.getAttribute('data-rule-id') == ruleId) {
            row.classList.add('table-warning', 'editing-rule');
        }
    });
}

// Function to clear any highlights from previously edited rules
function clearRuleHighlights() {
    const highlightedRows = document.querySelectorAll('.editing-rule');
    highlightedRows.forEach(row => {
        row.classList.remove('table-warning', 'editing-rule');
    });
}

// Initialize the form when the DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener for test rule button
    document.getElementById('testRuleBtn').addEventListener('click', function() {
        testRule();
    });

    // Add event listeners for edit buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.edit-rule-btn')) {
            const btn = e.target.closest('.edit-rule-btn');
            const ruleId = btn.getAttribute('data-rule-id');
            const name = btn.getAttribute('data-rule-name');
            const action = btn.getAttribute('data-rule-action');
            const priority = btn.getAttribute('data-rule-priority');
            const enabled = btn.getAttribute('data-rule-enabled') === 'true'; // Ensure boolean conversion

            let conditions;
            try {
                const conditionsStr = btn.getAttribute('data-rule-conditions');
                if (conditionsStr && conditionsStr.trim() !== '' && conditionsStr !== 'null' && conditionsStr !== '[]') {
                    conditions = JSON.parse(conditionsStr);
                    // Ensure conditions is an array, default to empty array if parsing fails or result is not an array
                    if (!Array.isArray(conditions)) {
                        conditions = [];
                    }
                } else {
                    conditions = [];
                }
            } catch (e) {
                console.error('Error parsing conditions:', e);
                conditions = [];
            }

            editRule(ruleId, name, action, priority, enabled, conditions);
        }

        // Handle add condition button
        if (e.target.closest('.add-condition-btn')) {
            e.preventDefault();
            addCondition();
        }

        // Handle remove condition buttons (for dynamically generated ones)
        if (e.target.closest('.remove-condition')) {
            e.preventDefault();
            const btn = e.target.closest('.remove-condition');
            const conditionGroup = btn.closest('.condition-group');
            if (conditionGroup) {
                const conditionId = conditionGroup.getAttribute('data-condition');
                removeCondition(conditionId);
            }
        }

        // Handle reset form button
        if (e.target.closest('.reset-form-btn')) {
            e.preventDefault();
            if (confirm('Are you sure you want to reset the form? All unsaved changes will be lost.')) {
                resetForm();
            }
        }
    });

    // Initialize the first condition if the form is not for editing
    // Check if there's an 'edit' parameter in the URL or if rule_id is already present in the form
    const urlParams = new URLSearchParams(window.location.search);
    const formActionInput = document.getElementById('ruleForm')?.querySelector('input[name="action"]');
    
    if (!urlParams.has('edit') && (!formActionInput || formActionInput.value === 'add')) {
       if (!document.querySelector('#conditions-container .condition-group')) {
           addCondition();
       }
    }
});

// Function to test rule against existing events
function testRule() {
    // Collect form data
    const formData = new FormData();
    formData.append('action', 'test');

    // Get basic rule info
    const nameInput = document.getElementById('name');
    const actionSelect = document.getElementById('rule_action');
    const priorityInput = document.getElementById('priority');
    const enabledInput = document.getElementById('enabled');

    if (!nameInput || !actionSelect || !priorityInput || !enabledInput) {
        alert('Form elements not found. Cannot test rule.');
        return;
    }

    const name = nameInput.value;
    const action = actionSelect.value;
    const priority = priorityInput.value;
    const enabled = enabledInput.checked;

    if (!name.trim()) {
        alert('Please enter a rule name to test');
        return;
    }

    if (!action) {
        alert('Please select an action to test');
        return;
    }

    formData.append('name', name);
    formData.append('rule_action', action);
    formData.append('priority', priority);
    formData.append('enabled', enabled);

    // Collect conditions
    const conditions = [];
    const conditionGroups = document.querySelectorAll('.condition-group');

    conditionGroups.forEach((group) => {
        const fieldSelect = group.querySelector('.condition-field');
        const operatorSelect = group.querySelector('.condition-operator');
        const valueInput = group.querySelector('.condition-value');
        const logicSelect = group.querySelector('.condition-logic');
        const negateCheckbox = group.querySelector('.condition-negate');

        if (!fieldSelect || !operatorSelect || !valueInput || !logicSelect || !negateCheckbox) {
            console.warn('Skipping incomplete condition group.');
            return; // Skip if essential elements are missing
        }

        const field = fieldSelect.value;
        const operator = operatorSelect.value;
        const value = valueInput.value;
        const logic = logicSelect.value;
        const negate = negateCheckbox.checked;

        // Only add if field and operator are selected
        if (field && operator) {
            conditions.push({
                field: field,
                operator: operator,
                value: value,
                logic: logic,
                negate: negate
            });
        }
    });

    // Add conditions to form data
    formData.append('conditions', JSON.stringify(conditions));

    // Show loading state
    const testBtn = document.getElementById('testRuleBtn');
    const originalText = testBtn.innerHTML;
    testBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
    testBtn.disabled = true;

    // Send test request
    fetch('/rules', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        displayTestResults(data);
    })
    .catch(error => {
        console.error('Error testing rule:', error);
        alert(`Error testing rule: ${error.message}. Please check console for details.`);
        // Display a generic error message in the results section
        const resultsContent = document.getElementById('testResultsContent');
        if (resultsContent) {
            resultsContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Test failed:</strong> An error occurred while processing the request.
                </div>
            `;
            document.getElementById('testResultsSection').style.display = 'block';
        }
    })
    .finally(() => {
        // Restore button state
        if (testBtn) {
            testBtn.innerHTML = originalText;
            testBtn.disabled = false;
        }
    });
}

// Function to display test results
function displayTestResults(data) {
    const resultsSection = document.getElementById('testResultsSection');
    const resultsContent = document.getElementById('testResultsContent');

    if (!resultsSection || !resultsContent) {
        console.error('Test results section or content element not found.');
        return;
    }

    if (data.success) {
        const matchCount = data.matches.length;
        const totalEvents = data.total_events;
        const percentage = totalEvents > 0 ? ((matchCount / totalEvents) * 100).toFixed(1) : 0;

        let html = `
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h4>${matchCount}</h4>
                            <p class="mb-0">Events Matched</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <h4>${totalEvents}</h4>
                            <p class="mb-0">Total Events</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4>${percentage}%</h4>
                            <p class="mb-0">Match Rate</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        if (matchCount > 0) {
            html += `
                <h6><i class="fas fa-list me-2"></i>Sample Matching Events (showing first 10):</h6>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Sender</th>
                                <th>Subject</th>
                                <th>Recipients</th>
                                <th>ML Score</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            data.matches.slice(0, 10).forEach(event => {
                const sender = event.sender || 'N/A';
                const subject = event.subject || 'No subject';
                const recipientCount = event.recipient_count !== undefined ? event.recipient_count : 'N/A';
                const mlScore = event.ml_score !== undefined ? event.ml_score : 0;
                const status = event.status || 'unknown';

                let mlBadgeClass = 'bg-secondary';
                if (mlScore >= 0.7) mlBadgeClass = 'bg-danger';
                else if (mlScore >= 0.4) mlBadgeClass = 'bg-warning';
                else if (mlScore !== undefined) mlBadgeClass = 'bg-success';

                let statusBadgeClass = 'bg-warning';
                if (status === 'closed') statusBadgeClass = 'bg-success';

                html += `
                    <tr>
                        <td><a href="/event/${event.id}" class="text-decoration-none">#${event.id}</a></td>
                        <td><small>${sender}</small></td>
                        <td><small>${subject}</small></td>
                        <td><small>${recipientCount} recipient(s)</small></td>
                        <td>
                            <span class="badge ${mlBadgeClass}">
                                ${(mlScore * 100).toFixed(0)}%
                            </span>
                        </td>
                        <td>
                            <span class="badge ${statusBadgeClass}">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            if (matchCount > 10) {
                html += `<p class="text-muted mt-2"><small>... and ${matchCount - 10} more events</small></p>`;
            }
        } else {
            html += `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>No events matched your rule conditions.</strong> 
                    You may want to adjust your criteria or test with different conditions.
                </div>
            `;
        }

        html += `
            <div class="mt-3">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="hideTestResults()">
                    <i class="fas fa-times me-2"></i>Close Results
                </button>
            </div>
        `;

        resultsContent.innerHTML = html;
    } else {
        resultsContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Test failed:</strong> ${data.error || 'Unknown error'}
            </div>
        `;
    }

    // Show results section
    resultsSection.style.display = 'block';
    resultsSection.scrollIntoView({ behavior: 'smooth' });
}

// Function to hide test results
function hideTestResults() {
    const resultsSection = document.getElementById('testResultsSection');
    if (resultsSection) {
        resultsSection.style.display = 'none';
    }
}

</script>
{% endblock %}